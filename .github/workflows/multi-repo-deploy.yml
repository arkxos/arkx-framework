name: Multi-Repository Deploy

on:
  push:
    tags:
      - 'v*'
  push:
    branches: [ main, dev ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.3.0)'
        required: true
        default: '0.3.0'
      release_type:
        description: 'Release type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - snapshot
      repositories:
        description: 'Target repositories'
        required: true
        default: 'github,central'
        type: choice
        options:
          - github
          - central
          - github,central
          - all

env:
  MAVEN_OPTS: -Xmx1024m

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_type: ${{ steps.version.outputs.release_type }}
      is_snapshot: ${{ steps.version.outputs.is_snapshot }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version from tag or input
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          RELEASE_TYPE="release"
        elif [[ "${{ github.event_name }}" == "push" ]]; then
          VERSION="0.3.1-SNAPSHOT"
          RELEASE_TYPE="snapshot"
        else
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
        fi
        
        IS_SNAPSHOT="false"
        if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
          IS_SNAPSHOT="true"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
        echo "is_snapshot=$IS_SNAPSHOT" >> $GITHUB_OUTPUT
        
    - name: Update version in pom.xml
      run: |
        mvn versions:set -DnewVersion=${{ steps.version.outputs.version }} -DgenerateBackupPoms=false

  deploy-github:
    runs-on: ubuntu-latest
    needs: detect-version
    if: contains(github.event.inputs.repositories, 'github') || (github.event.inputs.repositories == '' && (needs.detect-version.outputs.is_snapshot == 'true' || github.event_name == 'push'))
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        server-id: github
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Update version
      run: |
        mvn versions:set -DnewVersion=${{ needs.detect-version.outputs.version }} -DgenerateBackupPoms=false
        
    - name: Build (skip tests)
      run: |
        mvn clean compile -B -DskipTests
        
    - name: Deploy to GitHub Packages
      run: |
        mvn clean deploy \
          -P github-packages \
          -DskipTests \
          -Dmaven.wagon.http.retryHandler.count=3
      env:
        MAVEN_USERNAME: ${{ github.actor }}
        MAVEN_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Notify GitHub Packages deployment
      run: |
        echo "ğŸš€ GitHub Packages deployment completed!"
        echo "ğŸ“¦ Version: ${{ needs.detect-version.outputs.version }}"
        echo "ğŸ”— Repository: https://github.com/arkxos/arkx-framework/packages"

  deploy-central:
    runs-on: ubuntu-latest
    needs: detect-version
    if: contains(github.event.inputs.repositories, 'central') || (github.event.inputs.repositories == '' && github.event_name == 'push' && github.ref == 'refs/tags/*')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        server-id: ossrh
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Update version
      run: |
        mvn versions:set -DnewVersion=${{ needs.detect-version.outputs.version }} -DgenerateBackupPoms=false
        
    - name: Build (skip tests)
      run: |
        mvn clean compile -B -DskipTests
        
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
        trust_level: 5
        
    - name: Deploy to Maven Central (Snapshot)
      if: needs.detect-version.outputs.is_snapshot == 'true'
      run: |
        mvn clean deploy \
          -P central-release \
          -DskipTests \
          -Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }}
      env:
        MAVEN_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        
    - name: Deploy to Maven Central (Release)
      if: needs.detect-version.outputs.is_snapshot == 'false'
      run: |
        mvn clean deploy \
          -P central-release,release \
          -DskipTests \
          -Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }}
      env:
        MAVEN_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        
    - name: Notify Maven Central deployment
      run: |
        echo "ğŸš€ Maven Central deployment completed!"
        echo "ğŸ“¦ Version: ${{ needs.detect-version.outputs.version }}"
        echo "ğŸ”— Snapshot Repository: https://oss.sonatype.org/content/repositories/snapshots/"
        echo "ğŸ”— Central Repository: https://search.maven.org/"

  create-release:
    runs-on: ubuntu-latest
    needs: [detect-version, deploy-github, deploy-central]
    if: needs.detect-version.outputs.is_snapshot == 'false' && github.event_name == 'push' && github.ref == 'refs/tags/*'
    steps:
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.detect-version.outputs.version }}
        release_name: Release ${{ needs.detect-version.outputs.version }}
        body: |
          ## ğŸš€ Release ${{ needs.detect-version.outputs.version }}
          
          ### ğŸ“¦ Available Repositories
          
          **GitHub Packages (Immediate Availability):**
          ```xml
          <repository>
              <id>github</id>
              <url>https://maven.pkg.github.com/arkxos/arkx-framework</url>
          </repository>
          ```
          
          **Maven Central (Sync may take 2-4 hours):**
          ```xml
          <repository>
              <id>central</id>
              <url>https://repo1.maven.org/maven2/</url>
          </repository>
          ```
          
          **Sonatype Snapshots (Immediate):**
          ```xml
          <repository>
              <id>sonatype-snapshots</id>
              <url>https://oss.sonatype.org/content/repositories/snapshots</url>
          </repository>
          ```
          
          ### ğŸ”§ Usage
          
          **For immediate access (GitHub Packages):**
          ```xml
          <dependency>
              <groupId>io.arkx.framework</groupId>
              <artifactId>arkx-framework</artifactId>
              <version>${{ needs.detect-version.outputs.version }}</version>
          </dependency>
          ```
          
          **For Maven Central (after sync):**
          ```xml
          <dependency>
              <groupId>io.arkx.framework</groupId>
              <artifactId>arkx-framework</artifactId>
              <version>${{ needs.detect-version.outputs.version }}</version>
          </dependency>
          ```
        draft: false
        prerelease: false

  notify-completion:
    runs-on: ubuntu-latest
    needs: [detect-version, deploy-github, deploy-central]
    if: always()
    steps:
    - name: Deployment Summary
      run: |
        echo "ğŸ‰ Deployment Summary"
        echo "===================="
        echo "ğŸ“¦ Version: ${{ needs.detect-version.outputs.version }}"
        echo "ğŸ“‹ Type: ${{ needs.detect-version.outputs.release_type }}"
        echo ""
        echo "ğŸ“Š Repository Status:"
        echo "ğŸŸ¢ GitHub Packages: ${{ needs.deploy-github.result == 'success' && 'Available' || 'Failed' }}"
        echo "ğŸŸ¢ Maven Central: ${{ needs.deploy-central.result == 'success' && 'Deployed' || 'Failed' }}"
        echo ""
        echo "ğŸ”— Quick Access Links:"
        echo "ğŸ“¦ GitHub Packages: https://github.com/arkxos/arkx-framework/packages"
        echo "ğŸ” Maven Central: https://search.maven.org/artifact/io.arkx.framework/arkx-framework"
        echo "âš¡ Sonatype Snapshots: https://oss.sonatype.org/content/repositories/snapshots/"
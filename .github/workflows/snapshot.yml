name: Deploy Snapshot to Maven Central

on:
  push:
    branches: [ main, dev ]
  workflow_dispatch:

env:
  MAVEN_OPTS: -Xmx1024m

jobs:
  deploy-snapshot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        server-id: ossrh
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Set snapshot version
      run: |
        # è·å–å½“å‰æ—¶é—´æˆ³
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        # è®¾ç½® SNAPSHOT ç‰ˆæœ¬
        mvn versions:set -DnewVersion=0.3.1-SNAPSHOT -DgenerateBackupPoms=false
        
    - name: Build and test
      run: |
        mvn clean test -B
        
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
        trust_level: 5
        
    - name: Deploy Snapshot
      run: |
        mvn clean deploy \
          -P central-release \
          -DskipTests \
          -Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }}
      env:
        MAVEN_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        
    - name: Notify deployment status
      run: |
        echo "ğŸš€ Snapshot deployment completed!"
        echo "ğŸ“¦ Version: 0.3.1-SNAPSHOT"
        echo "ğŸ”— Repository: https://oss.sonatype.org/content/repositories/snapshots/"
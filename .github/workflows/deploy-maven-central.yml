name: Deploy to Maven Central

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.3.0)'
        required: true
        default: '0.3.0'
      release_type:
        description: 'Release type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - snapshot

env:
  MAVEN_OPTS: -Xmx1024m

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        server-id: ossrh
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Configure Git user
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: Get version from tag or input
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_type=release" >> $GITHUB_OUTPUT
        else
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
        fi
        
    - name: Update version in pom.xml
      run: |
        mvn versions:set -DnewVersion=${{ steps.version.outputs.version }} -DgenerateBackupPoms=false
        
    - name: Build and test
      run: |
        mvn clean test -B
        
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
        trust_level: 5
        
    - name: Deploy to Maven Central (Snapshot)
      if: steps.version.outputs.release_type == 'snapshot'
      run: |
        mvn clean deploy \
          -P central-release \
          -DskipTests \
          -Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }}
      env:
        MAVEN_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        
    - name: Deploy to Maven Central (Release)
      if: steps.version.outputs.release_type == 'release'
      run: |
        mvn clean deploy \
          -P central-release,release \
          -DskipTests \
          -Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }}
      env:
        MAVEN_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        
    - name: Create GitHub Release
      if: steps.version.outputs.release_type == 'release'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        release_name: Release ${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        
    - name: Notify deployment status
      run: |
        echo "ðŸš€ Deployment completed!"
        echo "ðŸ“¦ Version: ${{ steps.version.outputs.version }}"
        echo "ðŸ“‹ Type: ${{ steps.version.outputs.release_type }}"
        echo "ðŸ”— Repository: https://search.maven.org/artifact/io.arkx.framework/arkx-framework"
name: Deploy to Maven Central

on:
  push:
    tags:
      - 'v*'
    branches: [ dev ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.3.0)'
        required: true
        default: '0.3.0'
      release_type:
        description: 'Release type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - snapshot
      deploy_to_central:
        description: 'Deploy to Maven Central'
        required: true
        default: true
        type: boolean

env:
  MAVEN_OPTS: -Xmx1024m

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_type: ${{ steps.version.outputs.release_type }}
      is_snapshot: ${{ steps.version.outputs.is_snapshot }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version from tag, branch, or input
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          # æ ‡ç­¾æ¨é€ - æ­£å¼ç‰ˆ
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_type=release" >> $GITHUB_OUTPUT
          echo "is_snapshot=false" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/heads/dev ]]; then
          # dev åˆ†æ”¯æ¨é€ - ä» pom.xml è¯»å–ç‰ˆæœ¬å·å¹¶æ·»åŠ  -SNAPSHOT
          BASE_VERSION=$(mvn help:evaluate -Dexpression=revision -q -DforceStdout)
          if [[ -z "$BASE_VERSION" ]]; then
            BASE_VERSION="0.1.0"
          fi
          # å¼ºåˆ¶æ·»åŠ  -SNAPSHOT åç¼€
          VERSION="${BASE_VERSION}-SNAPSHOT"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_type=snapshot" >> $GITHUB_OUTPUT
          echo "is_snapshot=true" >> $GITHUB_OUTPUT
        else
          # æ‰‹åŠ¨è§¦å‘
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          if [[ "$RELEASE_TYPE" == "snapshot" ]]; then
            echo "is_snapshot=true" >> $GITHUB_OUTPUT
          else
            echo "is_snapshot=false" >> $GITHUB_OUTPUT
          fi
        fi

  deploy-maven-central:
    needs: detect-version
    if: github.event.inputs.deploy_to_central == 'true' || (github.event_name == 'push' && (github.ref == 'refs/tags/*' || github.ref == 'refs/heads/dev'))
    runs-on: ubuntu-latest
    environment: maven

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Configure Maven settings for Sonatype Central
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << EOF
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                      http://maven.apache.org/xsd/settings-1.0.0.xsd">
          <servers>
            <server>
              <id>central</id>
              <username>${{ secrets.SONATYPE_CENTRAL_USERNAME }}</username>
              <password>${{ secrets.SONATYPE_CENTRAL_PASSWORD }}</password>
            </server>
          </servers>
        </settings>
        EOF
        echo "Generated settings.xml with server ID: central"
        
    - name: Configure Git user
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: Update version in pom.xml
      run: |
        # ç›´æ¥ä¿®æ”¹ revision å±æ€§ï¼Œé¿å… flatten æ’ä»¶è½¬æ¢ SNAPSHOT ä¸º timestamp
        if [[ "${{ needs.detect-version.outputs.is_snapshot }}" == "true" ]]; then
          # SNAPSHOT ç‰ˆæœ¬ï¼šä¿æŒ -SNAPSHOT åç¼€
          BASE_VERSION="${{ needs.detect-version.outputs.version }}"
          if [[ ! "$BASE_VERSION" == *"-SNAPSHOT" ]]; then
            BASE_VERSION="${BASE_VERSION}-SNAPSHOT"
          fi
          mvn -B versions:set-property -Dproperty=revision -DnewVersion="$BASE_VERSION" -DgenerateBackupPoms=false
        else
          # RELEASE ç‰ˆæœ¬ï¼šç›´æ¥è®¾ç½®
          mvn -B versions:set-property -Dproperty=revision -DnewVersion="${{ needs.detect-version.outputs.version }}" -DgenerateBackupPoms=false
        fi
        
    - name: Build and package artifacts
      run: |
        mvn clean package -B -DskipTests -Dgpg.skip=true
        
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
        trust_level: 5
        
    - name: Debug Maven settings
      run: |
        echo "=== Maven settings.xml ==="
        cat ~/.m2/settings.xml
        echo "=== Environment variables ==="
        echo "SONATYPE_CENTRAL_SERVER_ID: ${{ secrets.SONATYPE_CENTRAL_SERVER_ID }}"
        echo "SONATYPE_CENTRAL_USERNAME: ${{ secrets.SONATYPE_CENTRAL_USERNAME }}"
        echo "=== Maven effective settings ==="
        mvn help:effective-settings -P central-release
        
    - name: Deploy to Maven Central (skip rebuild)
      timeout-minutes: 30
      run: |
        if [[ "${{ needs.detect-version.outputs.is_snapshot }}" == "true" ]]; then
          echo "ğŸš€ Deploying SNAPSHOT version to Central Snapshots..."
          mvn deploy \
            -P central-snapshot \
            -DskipTests \
            -Dgpg.skip=true \
            --no-transfer-progress \
            -B
        else
          echo "ğŸš€ Deploying RELEASE version to Central Portal..."
          mvn deploy \
            -P central-release,release \
            -DskipTests \
            -Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }} \
            --no-transfer-progress \
            -B
        fi
        
        echo "âœ… Deployment completed successfully!"



  create-github-release:
    needs: [detect-version, deploy-maven-central]
    if: needs.detect-version.outputs.release_type == 'release' && (github.event.inputs.deploy_to_central == 'true' || (github.event_name == 'push' && github.ref == 'refs/tags/*'))
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate changelog
      id: changelog
      uses: metcalfc/changelog-generator@v4.5.0
      with:
        myToken: ${{ secrets.GH_TOKEN }}

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.detect-version.outputs.version }}
        release_name: Release ${{ needs.detect-version.outputs.version }}
        body: |
          ### Things that changed in this release
          ${{ steps.changelog.outputs.changelog }}
          
          ### Maven Central
          - https://search.maven.org/artifact/io.arkx.framework/arkx-framework
        draft: false
        prerelease: false
        
    - name: Notify deployment status
      run: |
        echo "ğŸš€ Deployment completed!"
        echo "ğŸ“¦ Version: ${{ needs.detect-version.outputs.version }}"
        echo "ğŸ“‹ Type: ${{ needs.detect-version.outputs.release_type }}"
        echo "ğŸ”— Maven Central: https://search.maven.org/artifact/io.arkx.framework/arkx-framework"
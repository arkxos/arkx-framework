name: China Repository Deploy

on:
  push:
    tags:
      - 'v*'
  push:
    branches: [ main, dev ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.3.0)'
        required: true
        default: '0.3.0'
      release_type:
        description: 'Release type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - snapshot
      repositories:
        description: 'Target repositories'
        required: true
        default: 'aliyun,tencent'
        type: choice
        options:
          - aliyun
          - tencent
          - huawei
          - gitee
          - all
          - aliyun,tencent
          - aliyun,huawei

env:
  MAVEN_OPTS: -Xmx1024m

jobs:
  detect-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_type: ${{ steps.version.outputs.release_type }}
      is_snapshot: ${{ steps.version.outputs.is_snapshot }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version from tag or input
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          RELEASE_TYPE="release"
        elif [[ "${{ github.event_name }}" == "push" ]]; then
          VERSION="0.3.1-SNAPSHOT"
          RELEASE_TYPE="snapshot"
        else
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
        fi
        
        IS_SNAPSHOT="false"
        if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
          IS_SNAPSHOT="true"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
        echo "is_snapshot=$IS_SNAPSHOT" >> $GITHUB_OUTPUT
        
    - name: Update version in pom.xml
      run: |
        mvn versions:set -DnewVersion=${{ steps.version.outputs.version }} -DgenerateBackupPoms=false

  deploy-aliyun:
    runs-on: ubuntu-latest
    needs: detect-version
    if: contains(github.event.inputs.repositories, 'aliyun') || github.event.inputs.repositories == 'all'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        server-id: aliyun-cloud
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Update version
      run: |
        mvn versions:set -DnewVersion=${{ needs.detect-version.outputs.version }} -DgenerateBackupPoms=false
        
    - name: Build (skip tests)
      run: |
        mvn clean compile -B -DskipTests
        
    - name: Deploy to Aliyun Cloud
      run: |
        mvn clean deploy \
          -P aliyun-cloud \
          -DskipTests \
          -Dmaven.wagon.http.retryHandler.count=3
      env:
        MAVEN_USERNAME: ${{ secrets.ALIYUN_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.ALIYUN_PASSWORD }}
        
    - name: Notify Aliyun deployment
      run: |
        echo "ğŸš€ Aliyun Cloud deployment completed!"
        echo "ğŸ“¦ Version: ${{ needs.detect-version.outputs.version }}"
        echo "ğŸ”— Repository: https://packages.aliyun.com/maven/repository/126334-release-hl3JHL"

  deploy-tencent:
    runs-on: ubuntu-latest
    needs: detect-version
    if: contains(github.event.inputs.repositories, 'tencent') || github.event.inputs.repositories == 'all'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Update version
      run: |
        mvn versions:set -DnewVersion=${{ needs.detect-version.outputs.version }} -DgenerateBackupPoms=false
        
    - name: Build (skip tests)
      run: |
        mvn clean compile -B -DskipTests
        
    - name: Deploy to Tencent Cloud
      run: |
        mvn clean deploy \
          -P tencent-cloud \
          -DskipTests \
          -Dmaven.wagon.http.retryHandler.count=3
        
    - name: Notify Tencent deployment
      run: |
        echo "ğŸš€ Tencent Cloud deployment completed!"
        echo "ğŸ“¦ Version: ${{ needs.detect-version.outputs.version }}"
        echo "ğŸ”— Repository: https://mirrors.cloud.tencent.com/nexus/repository/maven-public/"

  deploy-huawei:
    runs-on: ubuntu-latest
    needs: detect-version
    if: contains(github.event.inputs.repositories, 'huawei') || github.event.inputs.repositories == 'all'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Update version
      run: |
        mvn versions:set -DnewVersion=${{ needs.detect-version.outputs.version }} -DgenerateBackupPoms=false
        
    - name: Build (skip tests)
      run: |
        mvn clean compile -B -DskipTests
        
    - name: Deploy to Huawei Cloud
      run: |
        mvn clean deploy \
          -P huawei-cloud \
          -DskipTests \
          -Dmaven.wagon.http.retryHandler.count=3
        
    - name: Notify Huawei deployment
      run: |
        echo "ğŸš€ Huawei Cloud deployment completed!"
        echo "ğŸ“¦ Version: ${{ needs.detect-version.outputs.version }}"
        echo "ğŸ”— Repository: https://repo.huaweicloud.com/repository/maven/"

  deploy-gitee:
    runs-on: ubuntu-latest
    needs: detect-version
    if: contains(github.event.inputs.repositories, 'gitee') || github.event.inputs.repositories == 'all'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        server-id: gitee-go
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Update version
      run: |
        mvn versions:set -DnewVersion=${{ needs.detect-version.outputs.version }} -DgenerateBackupPoms=false
        
    - name: Build (skip tests)
      run: |
        mvn clean compile -B -DskipTests
        
    - name: Deploy to Gitee Go
      run: |
        mvn clean deploy \
          -P gitee-go \
          -DskipTests \
          -Dmaven.wagon.http.retryHandler.count=3
      env:
        MAVEN_USERNAME: ${{ secrets.GITEE_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.GITEE_PASSWORD }}
        
    - name: Notify Gitee deployment
      run: |
        echo "ğŸš€ Gitee Go deployment completed!"
        echo "ğŸ“¦ Version: ${{ needs.detect-version.outputs.version }}"
        echo "ğŸ”— Repository: https://packages.gitee.com/arkxos/arkx-framework/maven"

  create-release:
    runs-on: ubuntu-latest
    needs: [detect-version, deploy-aliyun, deploy-tencent, deploy-huawei, deploy-gitee]
    if: needs.detect-version.outputs.is_snapshot == 'false' && github.event_name == 'push' && github.ref == 'refs/tags/*'
    steps:
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.detect-version.outputs.version }}
        release_name: Release ${{ needs.detect-version.outputs.version }}
        body: |
          ## ğŸš€ Release ${{ needs.detect-version.outputs.version }}
          
          ### ğŸ“¦ å›½å†…å¯ç”¨ä»“åº“ï¼ˆå®æ—¶åŒæ­¥ï¼‰
          
          **é˜¿é‡Œäº‘æ•ˆä»“åº“ï¼ˆæ¨èï¼‰ï¼š**
          ```xml
          <repositories>
              <repository>
                  <id>aliyun-cloud-releases</id>
                  <url>https://packages.aliyun.com/maven/repository/126334-release-hl3JHL</url>
              </repository>
              <repository>
                  <id>aliyun-cloud-snapshots</id>
                  <url>https://packages.aliyun.com/maven/repository/126334-snapshot-k0fTE8</url>
              </repository>
          </repositories>
          ```
          
          **è…¾è®¯äº‘å¼€å‘è€…ä»“åº“ï¼š**
          ```xml
          <repositories>
              <repository>
                  <id>tencent-maven</id>
                  <url>https://mirrors.cloud.tencent.com/nexus/repository/maven-public/</url>
              </repository>
          </repositories>
          ```
          
          **åä¸ºäº‘å¼€å‘è€…ä»“åº“ï¼š**
          ```xml
          <repositories>
              <repository>
                  <id>huawei-maven</id>
                  <url>https://repo.huaweicloud.com/repository/maven/</url>
              </repository>
          </repositories>
          ```
          
          **Gitee Go ä»“åº“ï¼š**
          ```xml
          <repositories>
              <repository>
                  <id>gitee-maven</id>
                  <url>https://packages.gitee.com/arkxos/arkx-framework/maven</url>
              </repository>
          </repositories>
          ```
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          
          **å›½å†…ç”¨æˆ·æ¨èé…ç½®ï¼š**
          ```xml
          <repositories>
              <!-- é˜¿é‡Œäº‘æ•ˆï¼ˆæ¨èï¼Œé€Ÿåº¦å¿«ï¼‰ -->
              <repository>
                  <id>aliyun-cloud-releases</id>
                  <url>https://packages.aliyun.com/maven/repository/126334-release-hl3JHL</url>
              </repository>
              <repository>
                  <id>aliyun-cloud-snapshots</id>
                  <url>https://packages.aliyun.com/maven/repository/126334-snapshot-k0fTE8</url>
              </repository>
          </repositories>
          
          <dependency>
              <groupId>io.arkx.framework</groupId>
              <artifactId>arkx-framework</artifactId>
              <version>${{ needs.detect-version.outputs.version }}</version>
          </dependency>
          ```
        draft: false
        prerelease: false

  notify-completion:
    runs-on: ubuntu-latest
    needs: [detect-version, deploy-aliyun, deploy-tencent, deploy-huawei, deploy-gitee]
    if: always()
    steps:
    - name: China Repository Deployment Summary
      run: |
        echo "ğŸ‡¨ğŸ‡³ å›½å†…ä»“åº“éƒ¨ç½²æ€»ç»“"
        echo "=================="
        echo "ğŸ“¦ ç‰ˆæœ¬: ${{ needs.detect-version.outputs.version }}"
        echo "ğŸ“‹ ç±»å‹: ${{ needs.detect-version.outputs.release_type }}"
        echo ""
        echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€:"
        echo "ğŸŸ¢ é˜¿é‡Œäº‘æ•ˆ: ${{ needs.deploy-aliyun.result == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }}"
        echo "ğŸŸ¢ è…¾è®¯äº‘: ${{ needs.deploy-tencent.result == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }}"
        echo "ğŸŸ¢ åä¸ºäº‘: ${{ needs.deploy-huawei.result == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }}"
        echo "ğŸŸ¢ Gitee: ${{ needs.deploy-gitee.result == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }}"
        echo ""
        echo "ğŸ”— å¿«é€Ÿè®¿é—®é“¾æ¥:"
        echo "ğŸ“¦ é˜¿é‡Œäº‘æ•ˆ: https://packages.aliyun.com/maven/repository/126334-release-hl3JHL"
        echo "ğŸ“¦ è…¾è®¯äº‘: https://mirrors.cloud.tencent.com/nexus/repository/maven-public/"
        echo "ğŸ“¦ åä¸ºäº‘: https://repo.huaweicloud.com/repository/maven/"
        echo "ğŸ“¦ Gitee: https://packages.gitee.com/arkxos/arkx-framework/maven"
        echo ""
        echo "ğŸ’¡ æ¨èå›½å†…ç”¨æˆ·ä½¿ç”¨é˜¿é‡Œäº‘æ•ˆä»“åº“ï¼Œé€Ÿåº¦æœ€å¿«ï¼"